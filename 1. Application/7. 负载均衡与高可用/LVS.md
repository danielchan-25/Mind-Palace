---
title: "LVS"

---

# 1. 简介
`LVS (Linux Virtual Server)`，即Linux虚拟服务器。

它用于多服务器的负载均衡，工作在网络四层，可以实现高性能，高可用的服务器集群技术。

它易用，配置非常简单，且有多种负载均衡的方法。

它稳定可靠，即使在集群的服务器中某台服务器无法正常工作，也不影响整体效果，另外可扩展性也非常好。

它廉价，可把许多低性能的服务器组合在一起形成一个超级服务器。

是基于TCP/IP做的路由和转发，稳定性和效率极高。

## 1.1 优势
1. **抗负载能力强**：因为 LVS 工作方式的逻辑是非常简单的，而且工作在网络的第 4 层，仅作请求分发用，没有流量，所以在效率上基本不需要太过考虑。LVS 一般很少出现故障，即使出现故障一般也是其他地方（如内存、CPU等）出现问题导致 LVS 出现问题。
2. **配置性低**：这通常是一大劣势同时也是一大优势，因为没有太多的可配置的选项，所以除了增减服务器，并不需要经常去触碰它，大大减少了人为出错的几率。
3. **工作稳定**，因为其本身抗负载能力很强，所以稳定性高也是顺理成章的事，另外各种 LVS都有完整的双机热备方案，所以一点不用担心均衡器本身会出什么问题，节点出现故障的话，LVS 会自动判别，所以系统整体是非常稳定的
4. **无流量**，LVS 仅仅分发请求，而流量并不从它本身出去，所以可以利用它这点来做一些线路分流之用。没有流量同时也保住了均衡器的 IO性能不会受到大流量的影响
5. **LVS 基本上能支持所有应用**，因为 LVS 工作在第 4 层，所以它可以对几乎所有应用做负载均衡，包括 http、数据库、聊天室等。

## 1.2 角色
一个 LVS 集群往往包含以下角色：
- DS：Director Server。虚拟服务，负责调度
- RS：Real Server。后端真实的工作服务器
- VIP：向外部直接面向用户请求，作为用户请求的目标的IP地址
- DIP：Director Server IP，DS的IP
- RIP：Real Server IP，后端服务器的IP地址
- CIP：Client IP,访问客户端的IP地址

## 1.3 模式
LVS 提供了 3 种负载均衡模式，每种负载均衡模式适用的场景有差异，DR模式性能效率比较高，安全性很高，因此一般公司都推荐使用DR模式。
- NAT
- TUN
- LVS-DR

## 1.4 LVS 和 NGINX
LVS 和 Nginx 都可以用作多机负载方案，他们各有优缺点，在生产环境中需要好好分析实际情况并加以利用。
LVS：Linux虚拟机、流量调度、负载均衡。
Nginx：高性能代理服务器、系统内部流量分发、反向代理。

1. nginx 工作在网络的第 7 层，可以作为网页静态服务器，支持 Rewrite 重写规则；支持 GZIP压缩，节省带宽；可以做缓存；可以针对 http 应用本身来做分流策略，静态分离，针对域名、目录结构等 相比之下 LVS并不具备这样的功能，所以 nginx 单凭这点可以利用的场合就远多于 LVS 了；但 nginx 有用的这些功能使其可调整度要高于LVS，所以经常要去触碰，人为出现问题的几率也就大
2. nginx 对网络的依赖较小，理论上只要 ping 得通，网页访问正常，nginx 就能连得通，nginx同时还能区分内外网，如果是同时拥有内外网的节点，就相当于单机拥有了备份线路；LVS 就比较依赖于网络环境，目前来看服务器在同一网段内并且LVS 使用 direct 方式分流，效果较能得到保证。另外注意，LVS 需要向托管商至少申请多于一个 ip 来做 visual ip
3. nginx 安装和配置比较简单，测试起来也很方便，因为它基本能把错误用日志打印出来。LVS 的安装和配置、测试就要花比较长的时间，因为同上所述，LVS 对网络依赖性比较大，很多时候不能配置成功都是因为网络问题而不是配置问题，出了问题要解决也相应的会麻烦的多
4. nginx 也同样能承受很高负载且稳定，但负载度和稳定度差 LVS 还有几个等级：nginx 处理所有流量所以受限于机器 IO 和配置；本身的 bug 也还是难以避免的；nginx 没有现成的双机热备方案，所以跑在单机上还是风险比较大，单机上的事情全都很难说
5. nginx 可以检测到服务器内部的故障（健康检查），比如根据服务器处理网页返回的状态码、超时等等，并且会把返回错误的请求重新提交到另一个节点。目前 LVS 中 ldirectd 也能支持针对服务器内部的情况来监控，但 LVS 的原理使其不能重发请求。比如用户正在上传一个文件，而处理该上传的节点刚好在上传过程中出现故障，nginx 会把上传切到另一台服务器重新处理，而 LVS 就直接断掉了

### 1.4.1 适用业务场景
1. 网站建设初期（每日 PV 小于 100 万），可以选用 Nigix 作为反向代理负载均衡，因为其配置简单，性能也能满足一般的业务场景。如果考虑到负载均衡器是有单点问题，可以采用 Nginx + Keepalived 避免负载均衡器自身的单点问题。
2. 网站并发达到一定程度之后，为了提高稳定性和转发效率，可以使用 LVS、毕竟 LVS 比 Nginx 要更稳定，转发效率也更高。不过维护 LVS 对维护人员的要求也会更高，投入成本也更大。

### 1.4.2 LVS+Nginx 为什么会被同时使用
1. nginx 用来做 http 的反向代理，能够 upsteam 实现 http 请求的多种方式的均衡转发。由于采用的是异步转发可以做到如果一个服务器请求失败，立即切换到其他服务器，直到请求成功或者最后一台服务器失败为止。这可以最大程度的提高系统的请求成功率
2. lvs 采用的是同步请求转发的策略。这里说一下同步转发和异步转发的区别。同步转发是在 lvs 服务器接收到请求之后，立即 redirect 到一个后端服务器，由客户端直接和后端服务器建立连接。异步转发是 nginx 在保持客户端连接的同时，发起一个相同内容的新请求到后端，等后端返回结果后，由 nginx 返回给客户端
3. 进一步来说：当做为负载均衡服务器的 nginx 和 lvs 处理相同的请求时，所有的请求和响应流量都会经过 nginx；但是使用 lvs 时，仅请求流量经过 lvs 的网络，响应流量由后端服务器的网络返回
4. 也就是，当作为后端的服务器规模庞大时，nginx 的网络带宽就成了一个巨大的瓶颈
5. 但是仅仅使用 lvs 作为负载均衡的话，一旦后端接受到请求的服务器出了问题，那么这次请求就失败了。但是如果在 lvs 的后端在添加一层 nginx（多个），每个 nginx 后端再有几台应用服务器，那么结合两者的优势，既能避免单 nginx 的流量集中瓶颈，又能避免单 lvs 时一锤子买卖的问题
6. lvs + nginx 的使用中，nginx 还可以作为一个中间环节来减小后端 tomcat 的服务压力，以及做一些业务切换、分流、前置缓存的功能

## 1.5 负载均衡机制

前面我们说了LVS是工作在网络层。相对于其它负载均衡的解决办法，比如DNS域名轮流解析、应用层负载的调度、客户端的调度等，它的效率是非常高的。LVS的通过控制IP来实现负载均衡。IPVS是其具体的实现模块。IPVS的主要作用：安装在Director Server上面，在Director Server虚拟一个对外访问的IP（VIP）。用户访问VIP，到达Director Server，Director Server根据一定的规则选择一个Real Server，处理完成后然后返回给客户端数据。这些步骤产生了一些具体的问题，比如如何选择具体的Real Server，Real Server如果返回给客户端数据等等。IPVS为此有三种机制：

> 参考文档：
>
> https://blog.csdn.net/zsw07/article/details/105000776
>
> https://www.cnblogs.com/codebean/archive/2011/07/25/2116043.html